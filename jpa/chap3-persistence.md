# JPA 플러시
#cake

## 플러시란?
플러시는 영속성 컨텍스트의 변경 내용을 데이터베이스에 반영한다.
플러시는 일반적으로 트랜잭션을 커밋할 때 영속성 컨텍스트가 플러시된다.

* 여기서 잠깐, 영속성 컨텍스트란?
  애플리케이션과 데이터베이스 사이에서 객체를 보관하는 가상의 데이터베이스 같은 역할을 한다. 영속성 컨텍스트로 인해 1차 캐시, 동일성 보장, 트랜잭션을 지원하는 쓰기 지연, 변경 감지, 지연 로딩 기능을 사용할 수 있다.


::플러시를 실행하면 일어나는 일::
1. 변경 감지가 동작해서 영속성 컨텍스트에 있는 모든 엔티티를 스냅샷과 비교해서 수정된 엔티티를 찾는다. 수정된 엔티티는 수정 쿼리를 만들어 쓰기 지연 SQL 저장소에 등록한다.
2. 쓰기 지연 SQL 저장소의 쿼리를 데이터베이스에 전송한다.

::영속성 컨텍스트를 플러시하는 방법::
1. `em.flush()`를 호출한다.
   -> 거의 사용 안함. 강제 플러시와 같다.
2.  트랜잭션 커밋 시 플러시가 자동 호출
    -> 데이터베이스의 변경 내용을 SQL로 전달하지 않고 트랜잭선만 커밋하면 어떤 데이터도 데이터베이스에 반영되지 않는다. 따라서 트랜잭션을 커밋하기 전에 **꼭 플러시를 호출해서 영속성 컨텍스트의 변경 내용을 데이터베이스에 반영해야한다.**
    _JPA는 이러한 문제를 예방하기 위해 트랜잭션을 커밋할 때 플러시를 자동 호출한다._
3. JPQL 쿼리 실행 시 플러시가 자동 호출
   -> 쿼리 실행 전 영속성 컨텍스트를 플러시해 변경 내용을 DB에 반영해줘야한다. `find()`시에는 플러시가 실행되지 않는다.


### 플러시 모드 옵션
* FlushModeType.AUTO: 커밋이나 쿼리를 실행할 때 플러시(기본값)
* FlushModeType.COMMIT: 커밋할 때만 플러시

> 플러시라는 이름으로 인해 영속성 컨텍스트에 보관된 엔티티를 지운다고 생각하면 안됨.   
> 키 포인트는 영속성 컨텍스트의 변경 내용을 데이터베이스에 동기화하는 것이 플러시다!  